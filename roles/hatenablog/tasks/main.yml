---
- name: Lookup `private-values path`
  command: private-values path {{ private_values_project }}
  register: private_path
  changed_when: false
  check_mode: false

- name: Get latest blogsync ver.
  shell: |
    set -o pipefail
    curl -L -H "Authorization:$(private-values get dotfiles.GITHUB_API_TOKEN)" https://api.github.com/repos/motemen/blogsync/releases/latest | \
      jq -r '.tag_name'
  args:
    warn: false
  register: blogsync_ver
  changed_when: false
  check_mode: false

- name: Download blogsync.zip
  get_url:
    url: https://github.com/motemen/blogsync/releases/download/{{ blogsync_ver.stdout }}/blogsync_{{ blogsync_ver.stdout }}_darwin_amd64.zip
    dest: /tmp/blogsync_{{ blogsync_ver.stdout }}_darwin_amd64.zip

- name: unzip blogsync.zip
  unarchive:
    src: /tmp/blogsync_{{ blogsync_ver.stdout }}_darwin_amd64.zip
    dest: /tmp

- name: /usr/local/bin/blogsync
  copy:
    src: /tmp/blogsync_{{ blogsync_ver.stdout }}_darwin_amd64/blogsync
    dest: /usr/local/bin/blogsync
    mode: "0755"

- name: ~/.config/blogsync
  file: dest={{ ansible_env.HOME }}/.config/blogsync state=directory

- name: ~/.config/blogsync/config.yaml
  file: dest={{ ansible_env.HOME }}/.config/blogsync/config.yaml src={{ private_path.stdout }}/blogsync.yaml state=link
